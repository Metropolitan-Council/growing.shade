---
title: "Growing Shade methods"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: 
  github_document:
    toc: true
always_allow_html: true
urlcolor: blue
---

# block group issues

the current watermask in gee is only for metcouncil area; this dataset probably works for rest of state: https://gisdata.mn.gov/dataset/water-national-hydrography-data (but need something from WI in there too)

would want to focus only on residential area or city boundaries; ag land has different purposes/uses/challenges/sustainability goals. 

very slow when showing block groups across entire state

--
options:
focus on statistical areas; some of this won't be super useful either since ag land
focus on areas where population density is above some threshold

# intro


The Growing Shade Project couples remote sensing data and demographic data to create insights about the intersection between the natural environment and people in real-time. 

Because there are several steps which must be done in order, this document lays those steps out logically. 

These are the files that must be in the data folder:

- mn_tracts.rda
- eva_data_main.rda
- metadata.rda
- eab.rda
- ctu_list.rda
- nhood_list.rda
- redline.rda
- trans_stops.rda
- ctu_crosswalk.rda
- nhood_crosswalk.rda
- metc_region.rda

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, message = F, warning = F,
                      cache = F,
                      cache.path = "cache/")
library(tidyverse)
library(tigris)
library(sf)
# source("packages_global.R")

st_erase = function(x, y) st_difference(x, st_union(st_combine(y)))
`%not_in%` <- Negate(`%in%`)

```

# Create and export files for GEE

Google Earth Engine needs some assets created. 

```{r gee_assets}
# ######
# # Create a gridded area across the region to calibrate sentinel tree cover with 1m2 land cover tree data
# #####
# wholearea <- metc_region %>%
#   summarise(st_union(.))
# 
# # make a equal area grid; there are 704 tracts, so I want to make at least 1000 grids I think?
# g = st_make_grid(wholearea,
#                  n = c(36, 36)) %>% 
#   st_intersection(wholearea) 
# 
# geometry = st_sfc(lapply(1:length(g), function(x) st_geometrycollection()))
# df <- st_sf(id = 1:length(g), geometry = g)
# 
# # ggplot() +
# #   geom_sf(data = wholearea) +
# #   geom_sf(data = df,
# #           fill = "transparent")
# 
# sf::st_write(df, "~/Documents/GitHub/planting.shade/storymap-info/shapefiles/metc_grid.shp", append = FALSE)
# 


```


# Google Earth Engine

Need to run some things, export some things etc.

# Calibrate tree canopy coverage

For some good reasons we are going to use data from 2020 for the tree canopy coverage. But since Sentinel has a 10 meter squared pixel size, this is larger than a lot of trees. In exploring the data, it appears as if the canopy coverage from Sentinel is about two times higher than what it should be (based on aerial imagery). However, this does make sense, because Sentinel is likely saying that a 10x10m pixel has a tree, even if that tree doesn't cover the whole area. In essence, it's telling us where land is covered at least half by trees. But we can refine this further!! Let's calibrate with the outdated UMN 1 meter squared land use file. 

Use UMN TC 1m2 land use where trees = coniferous trees, deciduous trees, and forested wetland (this last category is a new addition to the tree acres!). 

```{r calibrate_trees}
calibrate_trees <- read_csv("../data-raw/TreeAcresCART/UMNTreeAcres_metcgrid_scale1_year2021.csv") %>% 
  rename(umn = `1`) %>%
  full_join(read_csv("../data-raw/TreeAcresCART/TreeAcres_metcgrid_year2021.csv") %>%
              rename(sentinel = `1`),
            by = 'id')
#if do equal area grid r2 = 0.9343173; calib = 0.6123283

# cor.test(~ umn + sentinel,
#          data = calibrate_trees)
# cor.test(~ umn + I(sentinel^2),
#          data = calibrate_trees)

calibrate_lm <- (lm(umn ~ sentinel, data = calibrate_trees))
calibrate_lm2 <- (lm(umn ~ 0 + sentinel, data = calibrate_trees))
calibrate_lm3 <- (lm(umn ~ I(sentinel ^ 2), data = calibrate_trees))
calibrate_lm4 <- (lm(log(umn) ~ sentinel, data = calibrate_trees))
anova(calibrate_lm, calibrate_lm2, calibrate_lm3, calibrate_lm4) # the middle model is best!

# AIC(calibrate_lm); AIC(calibrate_lm2); AIC(calibrate_lm3)
anova(calibrate_lm, calibrate_lm2)
anova(calibrate_lm2, calibrate_lm3)

summary(calibrate_lm2)$r.squared # r2
summary(calibrate_lm2)$coefficients[,4] # p-value

calib_coeff <- summary(calibrate_lm2)$coefficients[,1] # coefficient
calib_coeff

calibrate_trees %>%
  ggplot(aes(x = (umn), y = (sentinel * calib_coeff))) +
  geom_point(alpha = .5) +
  geom_abline(slope=1, intercept=0, col = 'blue', lwd = 2) +
  # geom_smooth(method = "lm", fill = NA)+
  theme_minimal()  +
  # councilR::theme_council()
  labs( x = "UMN tree acres in grid", y = "Sentinel tree acres in grid",
        title = "calibrated")
  # labs(y = expression ("Sentinel in"~m/s^2))

# 
# calibrate_trees %>%
#   ggplot(aes(x = (sentinel), y = (umn))) +
#   geom_point(alpha = .5) +
#   geom_abline(slope=calib_coeff, intercept=0, col = 'blue', lwd = 2) +
#   stat_smooth(aes(y = umn),method = "lm", formula = y ~ x + I(x^2), size = 1, color = "red", fill = NA) +
#   # stat_smooth(aes(y = umn),method = "lm", formula = y ~ log(x), size = 1, color = "green", fill = NA) +
#   # geom_smooth(method = "lm", fill = NA)+
#   theme_minimal()  +
#   labs( y = "UMN tree acres in grid", x = "Sentinel tree acres in grid", title = "UNcalibrated")

# 
# calibrate_trees %>%
#   ggplot(aes(x = (sentinel), y = (umn))) +
#   geom_point(alpha = .5) +
#   stat_smooth(fill = NA, method = "lm") +
#   # geom_abline(slope=calib_coeff, intercept=0, col = 'blue', lwd = 2) +
#   # stat_smooth(aes(y = umn),method = "lm", formula = y ~ log(x), size = 1, color = "red", fill = NA) +
#   # geom_smooth(method = "lm", fill = NA)+
#   theme_minimal()  +
#   labs( x = "UMN tree acres in grid", y = "Sentinel tree acres in grid",
#         title = "UNcalibrated")

```

Calib coeff is 0.885246, meaning that senitel sees about 11% more trees; or detects area with at least 89% tree canopy coverage. Sentinel sees 1000 acres, UMN sees more like 885 (890) acres. 

# get EAB data

```{r eab}
temp <- tempfile()
temp2 <- tempfile()

download.file(
  "https://resources.gisdata.mn.gov/pub/gdrs/data/pub/us_mn_state_mda/env_emerald_ash_borer/shp_env_emerald_ash_borer.zip",
  destfile = temp
)
unzip(zipfile = temp, exdir = temp2)
list.files(temp2)
eab <-
  sf::read_sf(paste0(temp2, pattern = "/eab_trees.shp")) %>%
  # filter()
  st_transform(4326)
files <- list.files(temp2, full.names = T)
file.remove(files)

eab_counts <- function(x, ...) {
  eab %>%
    st_transform(26915) %>%
    st_intersection(x %>%
                      st_transform(26915) %>%
                      st_buffer(0)) %>%
  st_drop_geometry() %>%
  group_by(!!!quos(...)) %>%
  count() %>%
  rename(EAB = n)
}

usethis::use_data(eab, overwrite = TRUE)
```





# Make geometry shapefiles and crosswalks

Since we're going to be making a map which shows census tracts, ctus, or neighborhoods depending on the user input, do the following:

- find centroid and zoom level of area (for reactive zooming, if I want to re-implement that)
- make a crosswalk of which tracts belong in each ctu/neighborhood
- get the tree canopy coverage of each tract
- get the count of EAB 

Make crosswalk linking tracts to ctus and neighborhoods


- get aland for nhood and city



```{r rawgeography_bg}
# find centroid of geographies
find_centroid <- function(x, ...) {
  points <- x %>%
    mutate(zoom = case_when(Shape_Area < 1e6 ~ 15,
                            Shape_Area < 1e8 ~ 13,
                            Shape_Area < 1e9 ~ 12,
                            TRUE ~ 11)) %>%
    st_transform(26915) %>%
    st_centroid() %>%
    st_transform(4326) %>%
    dplyr::select(!!!quos(...), geometry, zoom) %>%
    mutate(lat = unlist(map(.$geometry,1)),
           long = unlist(map(.$geometry,2))) %>%
    sf::st_drop_geometry()
  geos <- x %>%
    dplyr::select(!!!quos(...), city, geometry) %>%
    st_transform(4326)
  combo <- full_join(geos, points) %>%
    arrange(!!!(quos(...))) 
  return(combo)
}

########
# geos
######
# # tracts------
# mn_tracts_1 <- tigris::tracts(state = "MN",
#                             county = c("Anoka", "Carver", "Dakota", "Hennepin", "Ramsey", "Scott", "Washington"))%>%
#   sf::st_transform(4326) %>%
#   mutate(GEO_NAME = GEOID)# %>%
#   # mutate(Shape_Area = as.numeric(st_area(.)))

wi_bgs <- tigris::block_groups(state = "WI", county = c("Pierce", "Polk", "St. Croix"))
mn_bgs_1 <- tigris::block_groups(state = "MN", year = 2010) %>%
  bind_rows(wi_bgs) %>%
  sf::st_transform(4326) %>%
  mutate(GEO_NAME = GEOID) #%>%
  # filter(str_detect(GEO_NAME, "27003|27019|27037|27053|27123|27139|27163"))
  # mutate(Shape_Area = as.numeric(st_area(.)))
# sf::st_write(mn_bgs_1, "/Users/escheh/Documents/GitHub/planting.shade/storymap-info/shapefiles/mn_bgs_1.shp", append = FALSE)

### neighborhoods -----------
#st paul here: https://information.stpaul.gov/City-Administration/District-Council-Shapefile-Map/dq4n-yj8b
#minneap here: https://opendata.minneapolismn.gov/datasets/communities/explore?location=44.970861%2C-93.261718%2C12.85
#brooklyn park here: but no dl: https://gis.brooklynpark.org/neighborhoodinfo/

minneap <- read_sf("../data-raw/minneapolis communities/Minneapolis_Communities.shp") %>%
  rename(GEO_NAME = CommName) %>%
  mutate(Shape_Area = as.numeric(st_area(.))) %>%
  mutate(city = "Minneapolis")

stpaul <- read_sf("../data-raw/stpaul communities/geo_export_0c076f52-d6ff-4546-b9fa-bd9980de6e8a.shp") %>%
  mutate(Shape_Area = as.numeric(st_area(.))) %>%
  rename(GEO_NAME = name2) %>%
  mutate(city = "St. Paul") %>%
  mutate(GEO_NAME = case_when(GEO_NAME == "CapitolRiver Council" ~ "Downtown",
                              GEO_NAME == "Thomas-Dale/Frogtown" ~ "Frogtown",
                              GEO_NAME == "West Side Community Organization" ~ "West Side",
                              GEO_NAME == "West 7th Federation/Fort Road" ~ "West 7th-Fort Road",
                              GEO_NAME == "Highland" ~ "Highland Park",
                              GEO_NAME == "Summit Hill Association" ~ "Summit Hill",
                              GEO_NAME == "Eastview-Conway-Battle Creek-Highwood Hills" ~ "Battle Creek-Conway-Eastview-Highwood Hills",
                              GEO_NAME == "The Greater East Side" ~ "Greater East Side",
                              GEO_NAME == "Como" ~ "Como Park",
                              TRUE ~ GEO_NAME))

nhood_geo <- bind_rows(minneap, stpaul) #%>%
  # find_centroid(., GEO_NAME)

#### ctus -----------
temp <- tempfile()
temp2 <- tempfile()
download.file(
  "https://resources.gisdata.mn.gov/pub/gdrs/data/pub/us_mn_state_metc/bdry_metro_counties_and_ctus/shp_bdry_metro_counties_and_ctus.zip",
  destfile = temp
)
unzip(zipfile = temp, exdir = temp2)
list.files(temp2)

ctu_geo <- sf::read_sf(paste0(temp2, pattern = "/CTUs.shp")) %>%
  dplyr::select(CTU_NAME, Shape_Area) %>%
  add_column(city = "doesn't matter") %>%
  # find_centroid(., CTU_NAME) %>%
  dplyr::select(-city) %>%
  rename(GEO_NAME = CTU_NAME) 

files <- list.files(temp2, full.names = T)
file.remove(files)

```

get aland
```{r}
temp <- tempfile()
download.file("https://resources.gisdata.mn.gov/pub/gdrs/data/pub/us_mn_state_dnr/water_dnr_hydrography/gpkg_water_dnr_hydrography.zip", destfile = temp)
river_lake_all <- sf::read_sf(unzip(temp, "water_dnr_hydrography.gpkg")) 

ctu_land <- ctu_geo %>%
  st_transform(26915) %>%
  st_buffer(0) %>%
  st_erase(river_lake_all %>%
             st_union() %>%
             st_buffer(0)) %>%
  mutate(ALAND = as.numeric(st_area(.)))

nhood_land <- nhood_geo %>%
  st_transform(26915) %>%
  st_buffer(0) %>%
  st_erase(river_lake_all %>%
             st_union() %>%
             st_buffer(0)) %>%
  mutate(ALAND = as.numeric(st_area(.)))

mn_bgs_2 <- mn_bgs_1 #%>%
  # st_transform(26915) %>%
  # st_buffer(0) %>%
  # st_erase(river_lake_all %>%
  #            st_union() %>%
  #            st_buffer(0)) %>%
  # mutate(ALAND = as.numeric(st_area(.)))

```



```{r makecrosswalks_bg}
# fxns to make easy -----

# river layer to erase Mississippi and Minnesota rivers-------
river_lake_buffer <- river_lake_all %>%
  filter(NAME_DNR %in% c("Mississippi", "Minnesota", "St. Croix")) #%>% #these rivers are boundaries
  # st_buffer(200) %>% #add 10m buffer
  # # st_simplify(dTolerance = 100) %>%
  # # st_buffer(300) %>%
  # st_union() %>% st_buffer(0) 

# find crosswalks
find_crosswalks <- function(x) {
  crosswalk <- x %>%
  st_transform(26915) %>%
  st_buffer(-150) %>% #buffer the perimeter of the geography
  st_erase(river_lake_buffer %>%
             st_buffer(200) %>% #buffer out rivers
             st_union() %>% 
             st_buffer(0)) %>% 
  st_intersection(mn_bgs_1 %>% 
                    dplyr::select(GEOID) %>%
                    rename(tract_id = GEOID) %>%
                    st_transform(26915)) %>%
  st_drop_geometry()
    
  return(crosswalk)
}

ctu_crosswalk <- find_crosswalks(ctu_geo) %>%
  mutate(flag = case_when(GEO_NAME == "Blakeley Twp." & tract_id != "271390813001" ~ "remove", #minnesota river is squirrely
                   TRUE ~ "keep")) %>%
  filter(flag != "remove") %>% 
  dplyr::select(-flag)
nhood_crosswalk <- find_crosswalks(nhood_geo)

# test <- "Hilltop"
# test <- "Blakeley Twp."
# test <- "May Twp."
# test <- "Minneapolis"
# test <- "Lake Elmo"
# test <- "Landfall"
# test <- "South St. Paul"
test <- "Belle Plaine"
test <- "Belle Plaine Twp."
mn_bgs_1 %>%
  right_join(ctu_crosswalk %>% filter(GEO_NAME == test),
             by = c("GEOID" = "tract_id")) %>%
  ggplot()+
  geom_sf(data = filter(ctu_geo, GEO_NAME ==test), fill = "blue", alpha =.1, color = "blue")+
  # geom_sf(data = (mn_bgs_1 %>%
  #                   right_join(filter(ctu_crosswalk, tract_id =="271390813001"),
  #                              by = c("GEOID" = "tract_id"))), fill = "red", alpha =.1, color = "red")+
  geom_sf(fill = NA, lwd = 2)
# 
# test <- "The Greater East Side"
# mn_bgs_1 %>%
#   right_join(nhood_crosswalk %>% filter(GEO_NAME == test),
#              by = c("GEOID" = "tract_id")) %>%
#   ggplot()+
#   geom_sf(data = filter(nhood_geo, GEO_NAME ==test), fill = "blue", alpha =.1, color = "blue")+
#   geom_sf(fill = NA, lwd = 2)



usethis::use_data(ctu_crosswalk, overwrite = TRUE)
usethis::use_data(nhood_crosswalk, overwrite = TRUE)

wide_ctu_crosswalk_1 <- ctu_crosswalk %>%
  group_by(tract_id) %>%
  count() %>%
  left_join(ctu_crosswalk) %>%
  add_column(cities = 999) %>%
  dplyr::select(tract_id, GEO_NAME, cities, n) %>%
  # spread(cities, GEO_NAME)
  pivot_wider(names_from = cities, values_from = GEO_NAME, values_fn = list) %>%
  unnest_wider(`999`) 

wide_ctu_crosswalk <- wide_ctu_crosswalk_1 %>%
  mutate(jurisdiction = paste(`...1`, `...2`, `...3`, `...4`, `...5`, 
                              # `...6`, `...7`,
                              sep = ", ")) %>%
  dplyr::select(tract_id, jurisdiction) %>%
  mutate(jurisdiction = str_replace(jurisdiction, ", NA", ""),
         jurisdiction = str_replace(jurisdiction, ", NA", ""),
         jurisdiction = str_replace(jurisdiction, ", NA", ""),
         jurisdiction = str_replace(jurisdiction, ", NA", ""),
         jurisdiction = str_replace(jurisdiction, ", NA", ""),
         jurisdiction = str_replace(jurisdiction, ", NA", ""),
         jurisdiction = str_replace(jurisdiction, ", NA", "")) %>%
  rename(GEOID = tract_id)
usethis::use_data(wide_ctu_crosswalk, overwrite = TRUE)

```






```{r treecanopy_bg}
bg_canopy <- 
read_csv("../data-raw/TreeAcresCART/TreeAcres_blockgroups_year2021.csv",
                   col_types = cols(.default = "d", GEOID10 = "c")) %>%
  # read_csv("../data-raw/TreeAcres/TreeAcres_mnwi_blockgroups_year2021.csv",
  #                  col_types = cols(.default = "d", GEOID = "c")) %>%
  # rename(GEOID10 = GEOID) %>%
  replace(is.na(.), 0) %>%
  left_join(sf::st_drop_geometry(mn_bgs_2), by = c("GEOID10" = "GEOID")) %>%
  transmute(bg10 = GEOID10, 
            treeacres = `1`,
            landacres = ALAND / 4046.86,
            canopy_percent = treeacres / landacres * calib_coeff) #use calibration coefficient

## ctu canopy ----
canopy_ctu <- read_csv("../data-raw/TreeAcresCART/TreeAcres_ctus_year2021.csv",
                   col_types = cols(.default = "d", CTU_NAME = "c")) %>%
  mutate(CTU_NAME = if_else(CTU_NAME == "Credit River Twp.", "Credit River", CTU_NAME)) %>%
  left_join(ctu_land, by = c("CTU_NAME" = "GEO_NAME")) %>%
  transmute(GEO_NAME = CTU_NAME, 
            treeacres = `1`,
            landacres = ALAND / 4046.86,
            canopy_percent = treeacres / landacres * calib_coeff) 

## nhood canopy ----
canopy_nhood <- read_csv("../data-raw/TreeAcresCART/TreeAcres_neighborhoods_year2021.csv",
                   col_types = cols(.default = "d", GEO_NAME = "c")) %>%
  mutate(GEO_NAME = case_when(GEO_NAME == "CapitolRiver Council" ~ "Downtown",
                              GEO_NAME == "Thomas-Dale/Frogtown" ~ "Frogtown",
                              GEO_NAME == "West Side Community Organization" ~ "West Side",
                              GEO_NAME == "West 7th Federation/Fort Road" ~ "West 7th-Fort Road",
                              GEO_NAME == "Highland" ~ "Highland Park",
                              GEO_NAME == "Summit Hill Association" ~ "Summit Hill",
                              GEO_NAME == "Eastview-Conway-Battle Creek-Highwood Hills" ~ "Battle Creek-Conway-Eastview-Highwood Hills",
                              GEO_NAME == "The Greater East Side" ~ "Greater East Side",
                              GEO_NAME == "Como" ~ "Como Park",
                              TRUE ~ GEO_NAME)) %>%
  left_join(nhood_land, by = c("GEO_NAME" = "GEO_NAME")) %>%
  transmute(GEO_NAME = GEO_NAME, 
            treeacres = `1`,
            landacres = ALAND / 4046.86,
            canopy_percent = treeacres / landacres * calib_coeff) %>%
  full_join(read_csv("../data-raw/TreeAcresCART/UMNTreeAcres_neighborhoods_scale1_year2021.csv") %>%
                mutate(GEO_NAME = case_when(GEO_NAME == "CapitolRiver Council" ~ "Downtown",
                              GEO_NAME == "Thomas-Dale/Frogtown" ~ "Frogtown",
                              GEO_NAME == "West Side Community Organization" ~ "West Side",
                              GEO_NAME == "West 7th Federation/Fort Road" ~ "West 7th-Fort Road",
                              GEO_NAME == "Highland" ~ "Highland Park",
                              GEO_NAME == "Summit Hill Association" ~ "Summit Hill",
                              GEO_NAME == "Eastview-Conway-Battle Creek-Highwood Hills" ~ "Battle Creek-Conway-Eastview-Highwood Hills",
                              GEO_NAME == "The Greater East Side" ~ "Greater East Side",
                              GEO_NAME == "Como" ~ "Como Park",
                              TRUE ~ GEO_NAME))) %>%
  mutate(umn_canopy = `1`/landacres)

canopy_nhood %>%
  ggplot(aes(x = canopy_percent, y = umn_canopy)) + geom_point()

```


- process GEE code to link canopy with geography
  - GEE data is in repo "users/ehe/MetCoucil/GrowingShade_CanopyCoverage"
  - https://code.earthengine.google.com/a0da66053ecb26b668df4297c4ebed59




- bind everything together for city and nhood

```{r}
tree_summary <- function(x) {
  x %>%
    left_join(bg_canopy %>%
                rename(tract_id = bg10),
              by = "tract_id") %>%
    # st_drop_geometry() %>%
    group_by(GEO_NAME) %>%
    summarise(min = round(min(canopy_percent)*100, 1),
              max = round(max(canopy_percent)*100, 1),
              ntracts = n())
}

nhood_list_raw <- nhood_geo %>%
  full_join(tree_summary(nhood_crosswalk)) %>%
  # full_join(eab_counts(., GEO_NAME)) %>%
  #   mutate(EAB = ifelse(is.na(EAB), 0, EAB)) %>%
  full_join(canopy_nhood) %>%
  arrange(city, GEO_NAME) %>%
  st_transform(4326) %>%
  group_by(city) %>%  
  # mutate(avgcanopy = mean(canopy_percent, na.rm = T))
  mutate(avgcanopy = (sum(treeacres) / sum(landacres) * calib_coeff))



  # group_by(city) %>% mutate(tree = sum(treeacres), land = sum(landacres), avgcanopy = tree/land * calib_coeff,
                            # umncanopy = sum(`1`/land))
# usethis::use_data(nhood_list, overwrite = TRUE)


ctu_list_raw <- ctu_geo %>%
  full_join(tree_summary(ctu_crosswalk)) %>%
    full_join(eab_counts(., GEO_NAME)) %>%
    mutate(EAB = ifelse(is.na(EAB), 0, EAB)) %>%
  full_join(canopy_ctu) %>%
  arrange(GEO_NAME) %>%
  st_transform(4326) %>%
  mutate(avgcanopy = (sum(treeacres) / sum(landacres) * calib_coeff))
  # mutate(avgcanopy = mean(canopy_percent, na.rm = T))

#should check credit river / credit river twp.
# nhood_list_raw %>% arrange(avgcanopy, canopy_percent)

# usethis::use_data(ctu_list, overwrite = TRUE)
# usethis::use_data(ctu_list2, overwrite = TRUE)

# sf::st_write(ctu_list, "~/Documents/GitHub/planting.shade/storymap-info/shapefiles/ctu_list.shp", append = FALSE)


```



# Demographic variables and rescale


```{r ndvi_bgs}
ndvi_uncultivated <- 
  read_csv("../data-raw/TreeAcresCART/uncultivatedNDVI_blockgroups_year2021.csv",
                    na = "No data",
                       col_types = cols(GEOID10 = "c", `system:index` = "c", Year = 'd',  `.geo` = 'c')) %>%
  rename(GEOID = GEOID10)

ndvi_allland <- 
  read_csv("../data-raw/TreeAcresCART/landNDVI_blockgroups_year2021.csv",
                    na = "No data",
                       col_types = cols(GEOID10 = "c", `system:index` = "c", Year = 'd',  `.geo` = 'c')) %>%
  rename(GEOID = GEOID10)
  
  # read_csv("../data-raw/TreeAcres/meanNDVI_mnwi_blockgroups_year2021.csv",
  #                   na = "No data",
  #                      col_types = cols(GEOID = "c", `system:index` = "c", Year = 'd', ndvi = 'd', `.geo` = 'c')) %>%
  # dplyr::select(-`system:index`, -.geo, -Year)
bg_ndvi <- ndvi_uncultivated %>%
  dplyr::select(GEOID, ndvi_uncultivated) %>%
  full_join(ndvi_allland %>%
  dplyr::select(GEOID, ndvi_land)) %>%
    rename(bg10 = GEOID)




```

```{r acsdata_bgs}
###################
# download acs dataset
###################
# temp <- tempfile()
# download.file("https://resources.gisdata.mn.gov/pub/gdrs/data/pub/us_mn_state_metc/society_census_acs/xlsx_society_census_acs.zip",
#   destfile = temp
# )

acs <- read_csv("/Volumes/shared/CommDev/Research/Research/Census Data/ACS_SF/2_OutputData/CSV/acs20195_bg.csv") %>% #readxl::read_xlsx(unzip(temp, "CensusACSBlockGroup.xlsx")) %>%
  janitor::clean_names() 

acs_tractsonly <- read_csv("/Volumes/shared/CommDev/Research/Research/Census Data/ACS_SF/2_OutputData/CSV/acs20195_tr.csv") %>% # readxl::read_xlsx(unzip(temp, "CensusACSTract.xlsx")) %>%
  janitor::clean_names()

fs::file_delete("CensusACSTract.xlsx")
fs::file_delete("CensusACSBlockGroup.xlsx")

##------some variables only exist at the tract levels
tract_acs <- acs_tractsonly %>%
  dplyr::select(geog_unit,
                anydis,
                cdenom) %>%
  transmute(tr10 = geog_unit,
            pd_any = anydis / cdenom)

## --------------variables of interest
bg_acs <- acs %>%
  dplyr::select(geog_unit, 
         pov185rate,
         poptotal,
         whitenh,
         ageunder18,
         age65up,
         medianhhi,
         blacknh,
         asiannh, pacificnh,
         hisppop,
         amindnh,
         homeownpct,
         multracenh, othernh
         ) %>%
  rowwise() %>%
  transmute(
    bg10 = geog_unit,
    ppov185 = pov185rate,
    mdhhincnow = medianhhi,
    pownhome = homeownpct,
    # pwhitenh = whitenh / poptotal,
         pblacknh = blacknh / poptotal,
         pasiannh = (asiannh + pacificnh) / poptotal,
         phisppop = hisppop / poptotal,
         pamindnh = amindnh / poptotal,
        pothmultnh = (multracenh + othernh) / poptotal,
         pbipoc = 1 - (whitenh / poptotal),
         p_0017 = ageunder18 / poptotal,
         p_65up = age65up / poptotal,
         sens_age = p_0017 + p_65up) %>%
  mutate(tr10 = substr(bg10, 1, 11)) %>%
  full_join(tract_acs %>% mutate(tr10 = as.character(tr10)))

  
```


```{r equityconsiderations_bg}
##########
# equity considerations data in some cases
#########
equity_bg <- read_csv("/Volumes/shared/CommDev/Research/Research/EquityConsiderationsData/2_OutputData/CSV/Release_20210225/EquityConsiderationsBlockGroups.csv",
                   col_types = cols( .default = "?", BG10 = "c")) %>%
  janitor::clean_names() 
equity_data_raw_bg <- equity_bg %>%
  dplyr::select(bg10,
         prim_flood,
         avg_temp,
         phhi_qntl1,
         green_roof,
         env_cancer,
         luse_green,
         tr_ej,
         holc_pred, holc_pgrn, holc_pblu, holc_pylw,
         pwk_nowork,
         poptot_mc,
         hutot_mc
         ) %>%
  rowwise() %>%
  mutate(holc_pred = if_else(is.na(holc_pred), 0, holc_pred)#,
         )

```


# cdc data
- Enter in the console: `usethis::edit_r_environ()`
- When the `.Renviron` file comes up in the editor, type: `CDC_KEY="KEY GOES HERE, INSIDE QUOTES"`
- Save and close the `.Renviron` file.
- Hit Ctrl+Shift+F10 to restart R.


```{r health_bgs}
##########
# CDC health data
#########
# variable options are documented here: https://www.cdc.gov/places/measure-definitions/index.html
# api token: https://chronicdata.cdc.gov/profile/edit/developer_settings

library("RSocrata")
#metadata https://dev.socrata.com/foundry/chronicdata.cdc.gov/cwsq-ngmh

bg_health <- read.socrata(
  "https://chronicdata.cdc.gov/resource/cwsq-ngmh.json?$where=stateabbr in('MN', 'WI')",
  app_token = "D1kEEJEDVBpDppDIdDmwNXeVT", #CDC_TOKEN,
  email     = "ellen.esch@metc.state.mn.us",
  password  = "TQfY5%Q3xY") %>% #CDC_KEY) %>%
  rename(GEOID10 = locationname)

bg_health
names(bg_health)
levels(as.factor(bg_health$measure))

bg_health2 <- bg_health %>%
  filter(measure %in% c("Current asthma among adults aged >=18 years",
                        "Chronic obstructive pulmonary disease among adults aged >=18 years",
                        "Mental health not good for >=14 days among adults aged >=18 years",
                        "Physical health not good for >=14 days among adults aged >=18 years")) %>%
  dplyr::select(GEOID10, measureid, data_value) %>%
  mutate(data_value = as.numeric(data_value) / 100) %>% #change to fraction
  pivot_wider(names_from = measureid, values_from = data_value) %>%
  rename(tr10 = GEOID10)

```





```{r combinedata_bgs}
###################
# combine data sources
###################

bg_growingshade_data_allMN <- bg_acs %>%
  # filter(str_detect(bg10, "27003|27019|27037|27053|27123|27139|27163")) %>%
  mutate(tr10 = as.character(substr(bg10, 1, 11)),
         bg10 = as.character(bg10)) %>% #this is the tract id
  # full_join(equity_data_raw_bg) %>%

# a <- eva_data_raw_bg %>%
#   mutate(cty = str_sub(bg10, 1, 5)) %>%
#   filter(str_detect(cty, "55"))
# levels(as.factor(a$cty))
  # full_join(acs_data_raw)
  left_join(equity_data_raw_bg) %>%
  left_join(bg_canopy %>% mutate(bg10 = as.character(bg10))) %>%
  left_join(bg_ndvi %>% mutate(bg10 = as.character(bg10))) %>%
  left_join(bg_health2) %>%
  mutate(inverse_ndvi_uncultivated = ndvi_uncultivated,
         inverse_ndvi_land = ndvi_land,
         canopy_percent2 = canopy_percent,
         pop_density = poptot_mc / landacres,
         housing_density = hutot_mc / landacres) %>%
  rename(tract_string = bg10) #%>% #and for this project, I need to rename the tract variable
  # add_column(avg_temp = sample(100, size = nrow(bg_canopy), replace = TRUE),
             # env_cancer = sample(100, size = nrow(bg_canopy), replace = TRUE),
             # green_roof = sample(100, size = nrow(bg_canopy), replace = TRUE),
             # holc_pred = sample(100, size = nrow(bg_canopy), replace = TRUE),
             # luse_green = sample(100, size = nrow(bg_canopy), replace = TRUE),
             # phhi_qntl1 = sample(100, size = nrow(bg_canopy), replace = TRUE),
             # prim_flood = sample(100, size = nrow(bg_canopy), replace = TRUE),
             # pwk_nowork = sample(100, size = nrow(bg_canopy), replace = TRUE),
             # tr_ej = sample(100, size = nrow(bg_canopy), replace = TRUE)) %>%
  
bg_growingshade_data <- bg_growingshade_data_allMN %>%
  filter(str_detect(tract_string, "27003|27019|27037|27053|27123|27139|27163")) #just do metc region for now
  # dplyr::select(-tr10)


# sort(names(eva_data_raw))
# sort(names(bg_growingshade_data))

bg_growingshade_data %>%
  ggplot(aes(y = avg_temp,
             # x = ndvi_land
             # x = ndvi_uncultivated
             # x = canopy_percent
             )) +
  geom_point(aes(x = ndvi_land), col = 'black') #+
  # geom_point(aes(x = ndvi_uncultivated), col = "blue")
```



```{r}
###################
# add some human-readable metadata
###################

## -------------------------------describe data
#cc (climate change preset) = prim_flood, avg_temp, ndvi
#ej (environmental justice preset) = pbipoc, phhi_qntl1, prim_flood, avg_temp, ndvi
#ph (public health preset)
eva_data_codes <- tribble(~variable, ~name, ~type, ~interpret_high_value, ~cc, ~ej, ~ph, ~cons,
                          "pop_density", "Population density (persons / acre)", "people",  "high_opportunity", 0, 0, 0,  0,
                          "housing_density", "Housing unit density (units / acre)", "people",  "high_opportunity", 0, 0, 0,  0,
                          "ppov185",	"% people with income <185% of the poverty threshold", "dollar", "high_opportunity", 0, 1, 0, 0,
                          "prim_flood", "% developed acres in primary flood zone", "environment", "high_opportunity", 1, 0, 0, 0,
                          "pbipoc", "Race, % people of color", "people", "high_opportunity", 0, 1, 0, 0,
                          "p_0017", "Age, % under age 18", "people",  "high_opportunity", 0, 0, 0, 0, 
                          "p_65up", "Age, % age 65 or older", "people",  "high_opportunity", 0, 0, 0,  0,
                          "avg_temp", "Temperature on hot summer day", "environment",  "high_opportunity", 1, 0, 1, 0,
                          # "phhi_qntl1", "% households with annual income less than $35,000 (bottom quintile of households)", "people",  "high_opportunity", 0, 1, 0, 0,
                          # "green_roof", "Water holding potential of green roofs on commercial bldgs", "environment",  "high_opportunity", 
                          "env_cancer", "Lifetime cancer risk from air toxics", "health", "high_opportunity", 0, 0, 1,  0,
                          # "luse_notgreen", "% of tract NOT used for green space", "environment", "high_opportunity"
                          
                          "ndvi_uncultivated", "Greenness, uncultivated land (2021 NDVI)", "environment", "low_opportunity", 1, 0, 1,  0,
                          "inverse_ndvi_uncultivated", "Greenness, uncultivated land (2021 NDVI) - for conservation", "environment", "high_opportunity", 0, 0, 0, 1,
                          
                          "ndvi_land", "Greenness, all land (2021 NDVI)", "environment", "low_opportunity", 1, 0, 1,  0,
                          "inverse_ndvi_land", "Greenness, all land (2021 NDVI) - for conservation", "environment", "high_opportunity", 0, 0, 0, 0,
                          
                          "tr_ej", "MPCA area of environmental justice concern", "environment", "high_opportunity", 0, 0, 0, 0,
                          "holc_pred", "% of block group's land acreage redlined", "environment", "high_opportunity", 0, 0, 0, 0,
                          "canopy_percent", "Tree canopy in 2021 (%)", "environment", "low_opportunity", 1, 0, 1, 0,
                          "canopy_percent2", "Tree canopy in 2021 (%) - for conservation", "environment", "high_opportunity", 0, 0, 0, 1,
                          "mdhhincnow", "Median household income", "dollar", "low_opportunity", 0, 0, 0, 0, #, 2015-2019 period (in 2019 dollars)
                          "sens_age", "Age, % under age 18 or 65+", "people", "high_opportunity", 0,0,1,0,
                          "pd_any", "Disability, % any disability", "people", "high_opportunity", 0, 0, 0, 0,
                          "pblacknh", "Race, % Black or African American", "people", "high_opportunity", 0, 0, 0, 0,
                          "pothmultnh", "Race, % Multiracial or other", "people", "high_opportunity", 0, 0, 0, 0,
                          "pasiannh", "Race, % Asian or Pacific Islander", "people", "high_opportunity", 0, 0, 0, 0,
                          "phisppop", "Race, % Hispanic or Latino", "people", "high_opportunity", 0, 0, 0, 0,
                          "pamindnh", "Race, % Indigenous", "people", "high_opportunity", 0, 0, 0, 0,
                          "pwk_nowork", "% of unemployed residents", "dollar", "high_opportunity", 0, 0, 0, 0, # age 16-64 who did not work in past 12 months
                          "pownhome", "% of residents who own their home", "dollar", "high_opportunity", 0,0,0,0,
                          "MHLTH", "Mental health not good for >=14 days among adults (%)", "health", "high_opportunity", 0,0,0,0,
                          "PHLTH", "Physical health not good for >=14 days among adults (%)", "health", "high_opportunity", 0,0,0,0,
                          "COPD", "Chronic obstructive pulmonary disease among adults (%)", "health", "high_opportunity", 0,0,0,0,
                          "CASTHMA", "Asthma among adults (%)", "health", "high_opportunity", 0,0,0,0
                          )

###################
# #create final dataset - no spatial data here
# #note: spatial data should be joined after any summarizing is done to save some computation time
###################

# #long data
bg_growingshade_main <- bg_growingshade_data %>%
  pivot_longer(names_to = "variable", values_to = "raw_value", -c(tract_string, tr10)) %>% #end the code after this line if you just want the reshaped data
  group_by(variable) %>%
  mutate(MEAN = mean(raw_value, na.rm = T),
         SD = sd(raw_value, na.rm = T),
         MIN = min(raw_value, na.rm = T),
         MAX = max(raw_value, na.rm = T),
         COUNT = as.numeric(sum(!is.na(raw_value))),
         z_score = (raw_value - MEAN)/SD) %>%
  
  full_join(eva_data_codes, by = 'variable') %>%
  
  # #we want high opportunity to be a high value, so this reorders those values if needed
  # mutate(opportunity_zscore = case_when(interpret_high_value == "high_opportunity" ~ z_score,
  #                                       interpret_high_value == "low_opportunity" ~ z_score * (-1),
  #                                         TRUE ~ NA_real_)) %>%
  
  #create nominal weights
  mutate(weights_nominal = case_when(interpret_high_value == "high_opportunity" ~ (raw_value - MIN) / (MAX - MIN) * 10,
                                     interpret_high_value == "low_opportunity" ~ 10 - (raw_value - MIN) / (MAX - MIN) * 10,
                                     TRUE ~ NA_real_)) %>%
  
  #Weights Standard Score
  mutate(weights_scaled = case_when(interpret_high_value == "high_opportunity" ~ pnorm(z_score) * 10,
                                    interpret_high_value == "low_opportunity" ~ (10 - pnorm(z_score) * 10),
                                    TRUE ~ NA_real_)) %>%
  
  #weights rank
  mutate(weights_rank = case_when(interpret_high_value == "high_opportunity" ~ min_rank(desc(weights_nominal)) / COUNT * 10,
                                  interpret_high_value == "low_opportunity" ~ min_rank(desc(weights_nominal)) / COUNT * 10,
                                  TRUE ~ NA_real_)) %>%
  
  # #rank
  mutate(overall_rank = case_when(interpret_high_value == "high_opportunity" ~ min_rank(desc(as.numeric(weights_nominal))),
                                  interpret_high_value == "low_opportunity" ~ min_rank(desc(as.numeric(weights_nominal))))) %>%
  # 
  #clean
  dplyr::select(-MEAN, -SD, -MIN, -MAX)  %>%
  full_join(wide_ctu_crosswalk %>% rename(tr10 = GEOID)) %>%
  filter(!is.na(name))

########
# save data
########
usethis::use_data(bg_growingshade_main, overwrite = TRUE)
eva_data_codes %>% arrange(type, name)%>% select(type, name)



############
#all MN
##########
# #long data
bg_growingshade_main_allMN <- bg_growingshade_data_allMN %>%
  pivot_longer(names_to = "variable", values_to = "raw_value", -c(tract_string, tr10)) %>% #end the code after this line if you just want the reshaped data
  group_by(variable) %>%
  mutate(MEAN = mean(raw_value, na.rm = T),
         SD = sd(raw_value, na.rm = T),
         MIN = min(raw_value, na.rm = T),
         MAX = max(raw_value, na.rm = T),
         COUNT = as.numeric(sum(!is.na(raw_value))),
         z_score = (raw_value - MEAN)/SD) %>%
  
  full_join(eva_data_codes, by = 'variable') %>%
  
  # #we want high opportunity to be a high value, so this reorders those values if needed
  # mutate(opportunity_zscore = case_when(interpret_high_value == "high_opportunity" ~ z_score,
  #                                       interpret_high_value == "low_opportunity" ~ z_score * (-1),
  #                                         TRUE ~ NA_real_)) %>%
  
  #create nominal weights
  mutate(weights_nominal = case_when(interpret_high_value == "high_opportunity" ~ (raw_value - MIN) / (MAX - MIN) * 10,
                                     interpret_high_value == "low_opportunity" ~ 10 - (raw_value - MIN) / (MAX - MIN) * 10,
                                     TRUE ~ NA_real_)) %>%
  
  #Weights Standard Score
  mutate(weights_scaled = case_when(interpret_high_value == "high_opportunity" ~ pnorm(z_score) * 10,
                                    interpret_high_value == "low_opportunity" ~ (10 - pnorm(z_score) * 10),
                                    TRUE ~ NA_real_)) %>%
  #clean
  dplyr::select(-MEAN, -SD, -MIN, -MAX)  %>%
  # full_join(wide_ctu_crosswalk %>% rename(tr10 = GEOID)) %>%
  filter(!is.na(name))



```

Create metadata. While the average values for the block groups are needed to create zscores, those averages are not the regional averages. Ex average median income of block groups might be 60,000 but the regional average might be lower if there are more people living in ares with lower income. 


```{r}
# ########
# # create metadata
# #########
md1 <- bg_growingshade_main_allMN %>% 
  group_by(variable) %>% 
  summarise(MEANRAW = mean(raw_value, na.rm = T),
            MEANSCALED = mean(weights_scaled, na.rm = T))

acs_metadata <-
acs_tractsonly %>% #use tracts becuase it has info about disability
    filter(str_detect(geoid, "27003|27019|27037|27053|27123|27139|27163"),
           year == 2019) %>% #just do metc region for now
  dplyr::select(geoid, poptotal:pphother) %>%
  pivot_longer(names_to = "variable", values_to = "values", -geoid) %>%
  group_by(variable) %>%
  summarise(SUM = sum(values, na.rm = T)) %>%
  pivot_wider(names_from = variable, values_from = SUM) %>%
  transmute(rgn = "twin cities",
            ppov185 = (povertyn + poverty150 + pov150_185) / povdenom,
            pbipoc = (poptotal - whitenh) / poptotal,
            pamindnh = (amindnh) / poptotal,
            phisppop = hisppop / poptotal,
            pblacknh = blacknh / poptotal,
            pasiannh = (asiannh + pacificnh) / poptotal,
            pothmultnh = (othernh + multracenh) / poptotal,
            pownhome = ownerocc / hutotal,
            p_65up = age65up / poptotal,
            p_0017 = ageunder18 / poptotal,
            sens_age = (age65up + ageunder18) / poptotal,
            # pwk_nowork
            # mdhhincnow
            # prim_flood
            # holc_pred
            # tr_ej
            # ndvi
            # ndvi2
            # avg_temp
            # canopy_percent
            # canopy_percent2,
            # CASTHMA
            # COPD
            # env_cancer
            # MHLTH
            # PHLTH
            # pop_density
            pd_any = anydis / cdenom) %>%
  pivot_longer(names_to = "variable", values_to = "MEANRAW2", -rgn)

md_gee <- 
  tribble(~rgn, ~variable, ~MEANRAW2,
          "twin cities", "canopy_percent", ctu_list_raw$avgcanopy[1], 
          "twin cities", "canopy_percent2", ctu_list_raw$avgcanopy[1]#, 
          # "twin cities", "ndvi", , 
          # "twin cities", "ndvi2", , 
          # "twin cities", "avg_temp", ,
  )

metadata <- bg_growingshade_main_allMN %>%
  dplyr::group_by(type, name, variable, interpret_high_value, cc, ej, ph, cons) %>%
  dplyr::count() %>%
  dplyr::ungroup() %>%
  full_join(md1) %>%
  mutate(niceinterp = 
               case_when(interpret_high_value == "high_opportunity" ~ "Higher",
                         TRUE ~ "Lower"),
         nicer_interp = case_when(niceinterp == "Lower" ~ "Lower values = higher priority", 
                                  variable == "inverse_ndvi_uncultivated" ~ "Higher values = higher priority",
                                  variable == "inverse_ndvi_land" ~ "Higher values = higher priority",
                                  variable == "canopy_percent2" ~ "Higher values = higher priority",
                                  TRUE ~ "")) #%>%
  # full_join(acs_metadata %>%
  #             bind_rows(md_gee)) %>%
  # mutate(MEANRAW = if_else(!is.na(MEANRAW2), MEANRAW2, MEANRAW)) %>%
  # dplyr::select(-MEANRAW2, -rgn)

usethis::use_data(metadata, overwrite = TRUE)

```



# Highest priority by area

For storymap??

And to make tract database

```{r}
highest_p <- function(x) {
  test <- enquo(x)
  
   bg_growingshade_main_allMN %>%
  filter(name %in% (metadata %>%
                      filter(!!test == 1)))
}

highest_p(ph)

highest_p <- function(group_var) {
  selectedvars <- metadata %>%
    filter(!!enquo(group_var) == 1) %>%
    .[,2]
  bg_growingshade_main_allMN %>% 
    filter(name %in% selectedvars$name) %>%
      group_by(tract_string) %>%
      summarise(MEAN = mean(weights_scaled, na.rm = T))
}

priority_summary_1 <-highest_p(ph) %>% rename(`Public health` = MEAN) %>%
  full_join(highest_p(cons) %>% rename(Conservation = MEAN)) %>%
  full_join(highest_p(ej) %>% rename(`Environmental justice` = MEAN)) %>%
  full_join(highest_p(cc) %>% rename(`Climate change` = MEAN)) %>%
  pivot_longer(names_to = "preset", values_to = "score", -tract_string) 

priority_summary <- priority_summary_1 %>%
  group_by(tract_string) %>%
  summarise(score = max(score)) %>%
  left_join(priority_summary_1) %>%
  rename(highest_priority = preset) %>%
  rename(GEOID = tract_string)


a <- mn_bgs_1 %>%
  left_join(priority_summary_1, by = c())
ggplot() %>%
  
mn_bgs_1
```


highest priority all

```{r include=F, eval = F}

highest_p_all <- function(group_var) {
  selectedvars <- metadata %>%
    filter(!!enquo(group_var) == 1) %>%
    .[,2]
  bg_growingshade_main_allMN %>% 
    filter(name %in% selectedvars$name) %>%
      group_by(tract_string) %>%
      summarise(MEAN = mean(weights_scaled, na.rm = F))
}

priority_summary_1_all <-highest_p_all(ph) %>% rename(`Public health` = MEAN) %>%
  full_join(highest_p_all(cons) %>% rename(Conservation = MEAN)) %>%
  full_join(highest_p_all(ej) %>% rename(`Environmental justice` = MEAN)) %>%
  full_join(highest_p_all(cc) %>% rename(`Climate change` = MEAN)) %>%
  pivot_longer(names_to = "preset", values_to = "score", -tract_string) 

priority_summary_all <- priority_summary_1_all %>%
  group_by(tract_string) %>%
  summarise(score = max(score)) %>%
  left_join(priority_summary_1_all) %>%
  rename(highest_priority = preset) %>%
  rename(GEOID = tract_string)
  # pivot_wider(names_from = preset, values_from = score) %>%
  # left_join(bg_growingshade_main_allMN %>%
  # rename(scaled = weights_scaled,
  #        raw = raw_value) %>%
  # # ungroup() %>%
  # dplyr::select(tract_string, variable, scaled, raw) %>%
  # pivot_wider(names_from = variable, values_from = c(scaled, raw))) %>%
  # arrange(tract_string) #%>%
  # rename(block_group_id_2010 = tract_string)

cities <- tribble(~name, ~lat, ~lng,
        "Minneapolis", "44.9778", "-93.2650",
        "St. Paul", "44.9537", "-93.09",
        "Mankato", "44.1636", "-93.9994",
        "Duluth", "46.7867", "-92.1005",
        "St. Cloud", "44.5579", "-94.1632",
        "Rochester", "43.1566", "-77.6088") %>%
  st_as_sf(coords = c("lng", "lat"), remove = FALSE, 
    crs = 4326, agr = "constant")

mn_bgs_1 %>% #st_transform(4326) %>%
  right_join(priority_summary_1_all, by = c("GEOID10" = "tract_string")) %>%
  filter(!is.na(score), preset == "Environmental justice") %>%
  ggplot() +

  geom_sf(aes(fill = score), lwd = 0, color = "transparent") +
  # geom_sf(data = cities) +
      # ggrepel::geom_text_repel(data = cities, aes(x = lng, y = lat, label = name), 
      #   fontface = "bold", nudge_x = c(1, -1.5, 2, 2, -1), nudge_y = c(0.25, 
      #       -0.25, 0.5, 0.5, -0.5)) +

      # geom_text(data = cities, aes(x = lng, y = lat, label = name),
      #   size = 5, col = "black", fontface = "bold") +
  theme_void()+
    scale_fill_gradient2(low = "#ffffd4", mid = "#fe9929", high = "#8c2d04", midpoint = 6) +
  # scale_color_numeric(palette = "YlOrBr")
  # scale_fill_brewer(palette = "YlOrBr") + #n = 5,
  labs(fill = "Environmental\njustice\npriority\nscore")#+
  # coord_sf(xlim = c(-98, -90), ylim = c(43, 50), expand = FALSE)

mnstate <- tigris::states(cb = T) %>% filter(NAME == "Minnesota")
mn_bgs_1 %>%
  right_join(priority_summary_1_all, by = c("GEOID10" = "tract_string")) %>%
  filter(score >=5, preset == "Environmental justice") %>%
  ggplot() +
  geom_sf(data = mnstate, fill = "transparent")+
  geom_sf(aes(fill = score), lwd = 0, color = "transparent") +
  theme_void()+
    scale_fill_gradient2(low = "#ffffd4", mid = "#fe9929", high = "#8c2d04", midpoint = 7) +
  # scale_color_numeric(palette = "YlOrBr")
  # scale_fill_brewer(palette = "YlOrBr") + #n = 5,
  labs(fill = "Environmental\njustice\npriority\nscore")

# mapview::mapview(mn_bgs_1 %>%
#   right_join(priority_summary_1_all, by = c("GEOID10" = "tract_string")) %>%
#   filter(score >=5, preset == "Environmental justice"),
#   zcol = "score")
```

# export bg data


```{r bg_shapefiles_for_mapping}

# mn_bgs_raw <- mn_bgs_1 %>%
#   right_join(wide_ctu_crosswalk) %>%
#   full_join(eab_counts(., GEOID)) %>%
#   mutate(EAB = ifelse(is.na(EAB), 0, EAB)) %>%
#   full_join(bg_canopy %>% rename(GEOID = bg10)) %>%
#   full_join(priority_summary) %>%
#   full_join(priority_summary_1%>%
#               group_by(preset) %>% 
#               # mutate(rank = rank(-score)) %>%
#               # dplyr::select(-score) %>%
#               pivot_wider(names_from = preset, values_from = score)#rank)
#             %>% rename(GEOID = tract_string)) %>%
#   mutate(avgcanopy = mean(canopy_percent, na.rm = T)) %>%
#   dplyr::select(-STATEFP, -COUNTYFP, -TRACTCE, -BLKGRPCE, -NAMELSAD, -MTFCC, -FUNCSTAT, -INTPTLAT, -INTPTLON) %>%
#   sf::st_as_sf() %>%
#       sf::st_transform(4326) %>% 
#   filter(!is.na(highest_priority)) %>% #don't want greater mn in here
#     mutate(fancyname = case_when(substr(GEOID, 3, 5) == "053" ~ paste0("Hennepin County tract ", as.numeric(substr(GEOID, 6, 11))/100, ", block group ", as.numeric(substr(GEOID, 12, 12))),
#                                substr(GEOID, 3, 5) == "003" ~ paste0("Anoka County tract ", as.numeric(substr(GEOID, 6, 11))/100, ", block group ", as.numeric(substr(GEOID, 12, 12))),
#                                substr(GEOID, 3, 5) == "019" ~ paste0("Carver County tract ", as.numeric(substr(GEOID, 6, 11))/100, ", block group ", as.numeric(substr(GEOID, 12, 12))),
#                                substr(GEOID, 3, 5) == "037" ~ paste0("Dakota County tract ", as.numeric(substr(GEOID, 6, 11))/100, ", block group ", as.numeric(substr(GEOID, 12, 12))),
#                                substr(GEOID, 3, 5) == "123" ~ paste0("Ramsey County tract ", as.numeric(substr(GEOID, 6, 11))/100, ", block group ", as.numeric(substr(GEOID, 12, 12))),
#                                substr(GEOID, 3, 5) == "139" ~ paste0("Scott County tract ", as.numeric(substr(GEOID, 6, 11))/100, ", block group ", as.numeric(substr(GEOID, 12, 12))),
#                                substr(GEOID, 3, 5) == "163" ~ paste0("Washington County tract ", as.numeric(substr(GEOID, 6, 11))/100, ", block group ", as.numeric(substr(GEOID, 12, 12))),
#                                TRUE ~ NA_character_))
mn_bgs_raw <- mn_bgs_1 %>%
  full_join(wide_ctu_crosswalk) %>%
  full_join(eab_counts(., GEOID)) %>%
  mutate(EAB = ifelse(is.na(EAB), 0, EAB)) %>%
  full_join(bg_canopy %>% rename(GEOID = bg10)) %>%
  full_join(priority_summary_all) %>%
  full_join(priority_summary_1_all%>%
              group_by(preset) %>% 
              # mutate(rank = rank(-score)) %>%
              # dplyr::select(-score) %>%
              pivot_wider(names_from = preset, values_from = score)#rank)
            %>% rename(GEOID = tract_string)) %>%
  mutate(avgcanopy = mean(canopy_percent, na.rm = T)) %>%
  dplyr::select(-STATEFP, -COUNTYFP, -TRACTCE, -BLKGRPCE, -NAMELSAD, -MTFCC, -FUNCSTAT, -INTPTLAT, -INTPTLON) %>%
  sf::st_as_sf() %>%
      sf::st_transform(4326) %>% 
  # filter(!is.na(highest_priority)) %>% #don't want greater mn in here
    mutate(fancyname = case_when(substr(GEOID, 3, 5) == "053" ~ paste0("Hennepin County tract ", as.numeric(substr(GEOID, 6, 11))/100, ", block group ", as.numeric(substr(GEOID, 12, 12))),
                               substr(GEOID, 3, 5) == "003" ~ paste0("Anoka County tract ", as.numeric(substr(GEOID, 6, 11))/100, ", block group ", as.numeric(substr(GEOID, 12, 12))),
                               substr(GEOID, 3, 5) == "019" ~ paste0("Carver County tract ", as.numeric(substr(GEOID, 6, 11))/100, ", block group ", as.numeric(substr(GEOID, 12, 12))),
                               substr(GEOID, 3, 5) == "037" ~ paste0("Dakota County tract ", as.numeric(substr(GEOID, 6, 11))/100, ", block group ", as.numeric(substr(GEOID, 12, 12))),
                               substr(GEOID, 3, 5) == "123" ~ paste0("Ramsey County tract ", as.numeric(substr(GEOID, 6, 11))/100, ", block group ", as.numeric(substr(GEOID, 12, 12))),
                               substr(GEOID, 3, 5) == "139" ~ paste0("Scott County tract ", as.numeric(substr(GEOID, 6, 11))/100, ", block group ", as.numeric(substr(GEOID, 12, 12))),
                               substr(GEOID, 3, 5) == "163" ~ paste0("Washington County tract ", as.numeric(substr(GEOID, 6, 11))/100, ", block group ", as.numeric(substr(GEOID, 12, 12))),
                               TRUE ~ NA_character_)) %>%
  filter(ALAND > 0)

# usethis::use_data(mn_bgs, overwrite = TRUE)


mncounties <- tigris::counties(state = "MN") %>%
  filter(COUNTYFP %in% c("003", "019", "037", "053", "123", "139", "163"))
metc_region <- mncounties %>% group_by(COUNTYFP) %>% summarise(geometry = sf::st_union(geometry)) %>%
  st_simplify(dTolerance = 400)
usethis::use_data(metc_region, overwrite = TRUE)

```


# Simplify data for speed

```{r}
# nhood_list <- nhood_list %>% st_make_valid() %>% st_simplify(dTolerance = 100) %>% st_as_sf()
ctu_list <- ctu_list_raw %>% 
  st_transform(26915) %>%
  sf::st_simplify(dTolerance = 50, preserveTopology = T) %>%
  sf::st_transform(4326)
usethis::use_data(ctu_list, overwrite = TRUE)

nhood_list <- nhood_list_raw %>% 
  st_transform(26915) %>%
  sf::st_simplify(dTolerance = 50, preserveTopology = T) %>%
  sf::st_transform(4326)
usethis::use_data(nhood_list, overwrite = TRUE)

redline <- redline %>% 
  # st_transform(26915) %>%
  sf::st_simplify(dTolerance = 50, preserveTopology = T) %>%
  sf::st_transform(4326)
usethis::use_data(redline, overwrite = TRUE)

library(tidyverse); library(sf)
# lakes <- river_lake_all %>%
#   filter(SYSTEM %in% c("Lake"),
#          AREA_ACRES > 10) %>% #these rivers are boundaries
#   sf::st_transform(26915) %>%
#   st_union() %>%
#   st_buffer(-10) %>%
#   # smoothr::smooth(method = "ksmooth") %>%
#   sf::st_simplify(dTolerance = 50, preserveTopology = F) #There’s also a parameter preserveTopology which, when set to TRUE, makes sure that polygons are not reduced to lines or even removed, or that inner holes in them are removed during the simplification process.

# temp <- tempfile()
# download.file("https://resources.gisdata.mn.gov/pub/gdrs/data/pub/us_mn_state_dot/trans_airports/gpkg_trans_airports.zip", destfile = temp)
# airports <- sf::read_sf(unzip(temp, "trans_airports.gpkg"))  %>%
#   st_buffer(dist = .$RUNWAY_WID) %>%
#   st_union() %>%
#   # ggplot() + geom_sf()
#   # sf::st_simplify(dTolerance = 25, preserveTopology = F) %>%
#   sf::st_transform(4326) 
  

mn_bgs <- mn_bgs_raw %>% 
  # if I want to remove lakes; I don't love them removed tbh
  # st_transform(26915) %>%
  # st_erase(lakes) %>% 
  # st_erase(airports) %>%
  sf::st_simplify(dTolerance = 35, preserveTopology = T) %>%
  sf::st_transform(4326)
usethis::use_data(mn_bgs, overwrite = TRUE)


# leaflet::leaflet() %>%
#   leaflet::addPolygons(data = mn_bgs) %>%
#   leaflet::addPolygons(data = mn_bgs5, color = "red")
# object.size(mn_bgs) / 1e5
# object.size(mn_bgs5) / 1e5

bg_growingshade_main <- bg_growingshade_main_allMN %>%
  dplyr::select(tract_string, name, weights_scaled, raw_value)
usethis::use_data(bg_growingshade_main, overwrite = TRUE)

eab <- eab %>% dplyr::select(geometry)
usethis::use_data(eab, overwrite = TRUE)

# object.size(eab2) / 1e5
# object.size(eab) / 1e5
# # ggplot() +
# #   geom_sf(data = ctu_list) +
# #   geom_sf(data = ctu_list2, col = "blue", fill = NA)

```


# Export for PlanIt

```{r}
ctu_list %>%
  sf::st_drop_geometry() %>%
  dplyr::select(GEO_NAME, canopy_percent, min, max) %>%
  mutate(min = min/100, 
         max = max/100) %>%
  rename("CTU Name" = GEO_NAME,
         "Average tree %" = canopy_percent,
         "Lowest block group tree %" = min,
         "Highest block group tree %" = max) %>%
  write_csv("./PlanIttriva.csv")

```

# Export data for storymaps

```{r storymap-shp, include = F, eval = F}
race_exp <- bg_growingshade_main %>%
  filter(variable == "pbipoc") %>%
  mutate(raw_value = raw_value * 100) %>%
  left_join(mn_bgs_1 %>% rename(tract_string = GEOID)) %>%
  dplyr::select(tract_string, raw_value, geometry) %>%
  rename(pbipoc = raw_value) %>%
  st_as_sf()

sf::st_write(race_exp, "/Users/escheh/Documents/GitHub/planting.shade/storymap-info/shapefiles/race.shp", append = FALSE)


canopy_exp <- bg_growingshade_main %>%
  filter(variable == "canopy_percent") %>%
  mutate(raw_value = raw_value * 100) %>%
  left_join(mn_bgs_1 %>% rename(tract_string = GEOID)) %>%
  dplyr::select(tract_string, raw_value, geometry) %>%
  rename(canopy_percent = raw_value) %>%
  st_as_sf()

sf::st_write(canopy_exp, "/Users/escheh/Documents/GitHub/planting.shade/storymap-info/shapefiles/canopy.shp", append = FALSE)


income_exp <- bg_growingshade_main %>%
  filter(variable == "mdhhincnow") %>%
  mutate(raw_value = raw_value * 100) %>%
  left_join(mn_bgs_1 %>% rename(tract_string = GEOID)) %>%
  dplyr::select(tract_string, raw_value, geometry) %>%
  rename(mdhhincnow = raw_value) %>%
  st_as_sf()

sf::st_write(income_exp, "/Users/escheh/Documents/GitHub/planting.shade/storymap-info/shapefiles/income.shp", append = FALSE)


copd_exp <- bg_growingshade_main %>%
  filter(variable == "COPD") %>%
  mutate(raw_value = raw_value * 100) %>%
  left_join(mn_bgs_1 %>% rename(tract_string = GEOID)) %>%
  dplyr::select(tract_string, raw_value, geometry) %>%
  rename(COPD = raw_value) %>%
  st_as_sf()

sf::st_write(copd_exp, "/Users/escheh/Documents/GitHub/planting.shade/storymap-info/shapefiles/copd.shp", append = FALSE)


highestp_exp <- mn_bgs_1 %>%
  right_join(mn_bgs %>%
               sf::st_drop_geometry()) %>%
               select(GEOID, highest_priority)
sf::st_write(highestp_exp, "/Users/escheh/Documents/GitHub/planting.shade/storymap-info/shapefiles/highestpriority.shp", append = FALSE)

```


```{r treetrust-fig, include=F, eval=F}
# https://www.bls.gov/cpi/tables/supplemental-files/historical-cpi-u-202111.pdf
cpi05 <- 193.2
cpi21 <-  266.236
tribble(~`Benefits`, ~`Total ($)`, ~`SE ($)`, ~`$/tree`, ~`SE ($/tree)`, ~`$/capita`, ~`SE ($/capita)`,
 "Energy", 6824046, (483981), 34.36, (2.44), 8.79, (.62),
 "CO2", 826875, (58644), 4.16, (.3), 1.06, (.08),
 "Air quality", 1134334, (80450), 5.71, (.41), 1.46, (.1),
 "Stormwater", 9071809, (643399), 45.67, (3.24), 11.68, (.83),
 "Aesthetic/Other", 7076370, (501877), 35.63, (2.53), 9.11, (.65),
"Total Benefits", 24933434, (1766384), 125.53, (8.89), 32.10, (2.27)) %>%
  mutate(Total21 = `$/tree` * cpi21/cpi05) %>%
  ggplot(aes(x = Total21, y = Benefits)) +
  geom_point()




```

# carbon by tree stands from USForest Service EVALIDATOR

adapted from: https://extension.umn.edu/managing-woodlands/carbon-minnesota-trees-and-woodlands#manage-for-carbon-storage-2244060

access on web at: https://apps.fs.usda.gov/Evalidator/rest/Evalidator/fullreport?reptype=State&lat=0&lon=0&radius=0&snum=Aboveground and belowground carbon in live trees (at least 1 inch d.b.h./d.r.c), in short tons, on forest land&sdenom=Area of forest land, in acres&wc=272019&pselected=None&rselected=Forest Type MnDNR&cselected=Stand age 20 yr classes (0 to 100 plus)&ptime=Current&rtime=Current&ctime=Current&wf=&wnum=&wnumdenom=&FIAorRPA=FIADEF&outputFormat=HTML&estOnly=Y&schemaName=FS_FIADB.


```{r carbon-stand-age, include = F, eval = F}
usfs <- readxl::read_xlsx("../data-raw/evalidator fsusda.xlsx", 
                          skip = 1,
                          na = "-") %>%
  dplyr::select(-Total) %>%
  pivot_longer(names_to = "age",
               values_to = "carbon", 
               -`Forest Type MnDNR`) %>%
  rename("sps" = "Forest Type MnDNR") %>%
  filter(sps %not_in% c("Total", "Other",
                        "Other softwoods", "Non stocked",
                        "Cottonwood / Willow", "Eastern redcedar", "Balsam poplar", "White spruce", "Black spruce", "Balsam fir"))%>%
    mutate(age2 = case_when(age == "0-20 years" ~ "0-20",
                          age == "21-40 years" ~ "21-40",
                          age == "41-60 years" ~ "41-60",
                          age == "61-80 years" ~ "61-80",
                          age == "81-100 years" ~ "81-100",
                          age == "100+ years" ~ "100+",
                          TRUE ~ NA_character_)) %>%
  # group_by(sps) %>%
  mutate(age2 = factor(age2, levels=c("0-20",
                                    "21-40",
                                    "41-60",
                                    "61-80",
                                    "81-100",
                                    "100+")),
         label = case_when(age2 == "100+" ~ sps,
                           TRUE ~ NA_character_),
                  sps = fct_reorder(sps, desc(carbon))
         ) 


usfs_fig <- usfs %>%
  # group_by(sps)  %>%
  ggplot(aes(x = age2, y = carbon, color = sps, group = sps, shape = sps)) +
geom_line(lwd =1) +
  geom_point(aes(fill = sps),  size = 3) +
  # cowplot::theme_cowplot() +
  councilR::council_theme() +
  scale_color_brewer(palette = "Paired") +
  scale_fill_brewer(palette = "Paired") +
  # ggrepel::geom_label_repel(aes(label = label),
  #                 nudge_x = 1,
  #                 na.rm = TRUE
  #                 )
  ggrepel::geom_label_repel(
    aes("100+", carbon, label = label), col = "black", nudge_x = .5, direction = "y", hjust = "left",  ylim = c(-Inf, Inf),  xlim = c(NA, Inf)
  ) +
  scale_x_discrete(expand = expansion(mult = c(.05, 0.6))) +
  scale_shape_manual(values = rep((21:25), 3)) +
  guides(fill = "none", col = "none", shape = "none") +
  labs(x = "Stand age (years)", y = "Average\ncarbon\nstorage\n(US tons\nper acre)",
       caption = "US Forest Service EVALIDator v1.8.0.01") +
    theme(panel.grid.minor = element_blank(),
        panel.grid.major.x = element_blank(),
        axis.title.y = element_text(angle=0,
                                    vjust = .5),
        plot.margin = margin(7,7,7,7),
        legend.position = "none"#,
        # axis.ticks.x = element_line("grey")
        )

ggsave("./usfs_fig.jpg", usfs_fig,  width = 8, height = 5, units = "in", device = "jpg")

```




```{r testdl, include=F, eval=F}
# eh<-  sf::read_sf("/Users/escheh/Downloads/Data_shpExport/BufferedTracks.shp")
# 
# eh %>%
#   ggplot() +
#   geom_sf(aes(fill = Prcnttc))
```





